name: Update OSSF Scorecard Scope

on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
    
  workflow_dispatch:

  push:
    paths:
      - .github/workflows/update-scope.yml

permissions:
  contents: read

jobs:
  update-scope:
    runs-on: ubuntu-latest
    permissions:
      contents: write # To create branch and commit changes
      pull-requests: write # To create PR
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Load available actions
        uses: devops-actions/load-available-actions@b46a50119e29dd0930da799e49f36c7f33d98cb6 # v2.2.0
        id: load-actions
        with:
          PAT: ${{ secrets.GITHUB_TOKEN }}
          organization: devops-actions
          outputFilename: actions.json

      - name: Transform to scope.json format
        run: |
          node .github/scripts/transform-to-scope.js actions.json ossf-reporting/scope.json

      - name: Check for changes in the scope file
        id: check-changes
        run: |
          if git diff --quiet ossf-reporting/scope.json; then
            echo "No changes detected in scope.json"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected in scope.json"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            
            # Show the diff for logging
            echo "Diff:"
            git diff ossf-reporting/scope.json
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update OSSF scorecard scope with discovered actions'
          title: 'chore: Update OSSF Scorecard Scope'
          # only update the scope file
          add-paths: ossf-reporting/scope.json
          body: |
            ## Automated Scope Update
            
            This PR updates the OSSF Scorecard scope file with the latest discovered actions from the `devops-actions` organization.
            
            ### Changes
            - Automatically discovered all action repositories using `devops-actions/load-available-actions`
            - Filtered out archived repositories
            - Kept fork repositories in the list
            - Sorted repositories alphabetically
            
            ### Review Checklist
            - [ ] Verify all active action repositories are included
            - [ ] Confirm archived repositories are excluded
            - [ ] Check that no unexpected repositories were added
            
            ---
            _Generated by the [Update OSSF Scorecard Scope](.github/workflows/update-scope.yml) workflow_
          branch: automated/update-ossf-scope
          delete-branch: true
          labels: |
            automation
            dependencies
          assignees: ${{ github.repository_owner }}

      - name: Summary
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            {
              echo "✅ Created PR with updated scope.json"
              echo ""
              echo "### Changes"
              echo '```diff'
              git diff ossf-reporting/scope.json
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ℹ️ No changes needed - scope.json is up to date" >> "$GITHUB_STEP_SUMMARY"
          fi
